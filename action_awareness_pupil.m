%Stefano Ioannucci%  INCIA (Bordeaux, France)%  23/03/2019%based on code by Arnaud Boudin - IfA Do (Dortumund, Germany) - 06/06/2013%  Experiment: "Conscious awareness of action as mediator of implicit sensorimotor learning"%  Description: 1 test/train/test/train/test session on two 12-element%  movement sequences (99 trials) and a recall session of 3 trials with%  train sequence%% Screen and memory cleaningclearvars Screen('CloseAll');clc groupe = menu2('Groupe ','Control','Action');sujet = menu2('Sujet n??? ','1','2','3','4','5','6','7','8','9','10','11','12','13','14','15');session = menu2('Session ','Tag1','Tag2');eyetracker = menu2('Eyetracker', '0','1');selection = menu2(['Selection: Groupe',num2str(groupe),' Session Tag',num2str(session),' Sujet',num2str(sujet), 'Eyetracker',num2str(eyetracker)],'OK','Cancel');path = ['/home/incia/ownCloud/MATLAB/Data/SeqLearn/' num2str(groupe) '/' num2str(sujet)];if ~isdir(path)    mkdir(path);end dnow = datestr(now,'dd-mm-yyyy_HH-MM');if selection==2    quit;elseend                                 if session==1    nb_block = 1:99; % 3Pre + 45Train + 3Mid + 45Train +3Postelseif session==2    nb_block = 1:3; % Implicit recall + questionnaire at end   elseend%% Sequencesif session==1    Seq_repeat = [2 4 2 1 3 4 1 2 3 1 4 3]; %SEQ A    Seq_random = [2 4 1 3 2 1 4 2 3 4 3 1]; %SEQ B    elseif session==2    Seq_repeat = [2 4 2 1 3 4 1 2 3 1 4 3]; %SEQ A    end%% Creation of screensscreen=0;flipSpd=0;global wPtr[rect]=psychInit(eyetracker==2);resolution = rect(3:4);position_cible_x=floor(resolution(1)/2); % set target locations on the x axisposition_cible_y= floor(resolution(2)/2); % set the target locations on the y axistailleCible = 50;centre_x = position_cible_x;centre_y = position_cible_y;a1=centre_x-(tailleCible*2);b1=centre_y-tailleCible;a2=a1+tailleCible;b2=centre_y-tailleCible;a3=a1+(tailleCible*2);b3=centre_y-tailleCible;a4=a1+(tailleCible*3);b4=centre_y-tailleCible;monitorFlipInterval=Screen('GetFlipInterval', wPtr);Screen('FillRect',wPtr,[255 255 255], [a1 b1 (a1+tailleCible) (b1+tailleCible)]); % target 1Screen('FillRect',wPtr,[255 255 255], [a2 b2 (a2+tailleCible) (b2+tailleCible)]); % target 2Screen('FillRect',wPtr,[255 255 255], [a3 b3 (a3+tailleCible) (b3+tailleCible)]); % target 3Screen('FillRect',wPtr,[255 255 255], [a4 b4 (a4+tailleCible) (b4+tailleCible)]); % target 4Screen('FillRect',wPtr,[0 0 0], [a1+2 b1+2 (a1+(tailleCible-2)) (b1+(tailleCible-2))]); % target 1Screen('FillRect',wPtr,[0 0 0], [a2+2 b2+2 (a2+(tailleCible-2)) (b2+(tailleCible-2))]); % target 2Screen('FillRect',wPtr,[0 0 0], [a3+2 b3+2 (a3+(tailleCible-2)) (b3+(tailleCible-2))]); % target 3Screen('FillRect',wPtr,[0 0 0], [a4+2 b4+2 (a4+(tailleCible-2)) (b4+(tailleCible-2))]); % target 4vbl=Screen(wPtr, 'Flip');HideCursor;%% Experimental setup and loopk=0;FB=2;color=[0 255 0]; % stim colorgray=[100 100 100]; %background color% Variable foreperioda = [1:0.5:3];     % possible numbersw = [1 1 1 1 1];   % corresponding weightsN = length(nb_block);  % how many numbers to generateRd = a( sum( bsxfun(@ge, rand(N,1), cumsum(w./sum(w))), 2) + 1 );%%%%%% INITIALIZE EYE TRACKER %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%if eyetracker == 2    Eyelink('StartRecording');endfor b=nb_block    if eyetracker == 2    Eyelink('Message', sprintf('STARTTRIAL #%d:  %s  (see "TRIALSYNCTME" msg below for actual onset)',...         b, datestr(now,'HH:MM:SS')));    end    if session == 1        if b>0 && b<4            name=1;            %'Pre test'            if eyetracker == 2                Eyelink('Message', 'USEREVENT "SEQUENCE B"');            end        elseif b>3 && b<49            name=2;            %'Train1'            if eyetracker == 2                Eyelink('Message', 'USEREVENT "SEQUENCE A"');            end        elseif b>48 && b<52            name=1;            %'Mid test'            if eyetracker == 2                Eyelink('Message', 'USEREVENT "SEQUENCE B"');            end        elseif b>51 && b<97            name=2;            %'Train2'            if eyetracker == 2                Eyelink('Message', 'USEREVENT "SEQUENCE A"');            end        elseif b>96 && b<100            name=1;            %'Post test'            if eyetracker == 2                Eyelink('Message', 'USEREVENT "SEQUENCE B"');            end        end    end        if session==1 && name==1        Seq_repeated=Seq_random; %SEQ B in Test trials    else        Seq_repeated=Seq_repeat; %SEQ A in Train trials + in motor recall of session 2    end            % Recall session screen and procedure    if session==2 && b==1                Screen('FillRect',wPtr,gray);        vbl=Screen(wPtr, 'Flip');                Screen('TextFont',wPtr,'Arial');        Screen('TextSize',wPtr,19);        Screen('DrawText',wPtr,'Rappelez la sequence',(a1+15),b1-50,255);        Screen('DrawText',wPtr,'(Appuyez espace pour debuter)',(a1+15),b1,255);        vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));                if b>0 && b<4                        kc_space1 = KbName('Space');            startTime = GetSecs();            while 1                [keyIsDown secs keycodes] = KbCheck();                                if keycodes(kc_space1)                    break                end            end                       Screen('FillRect',wPtr,gray);        vbl=Screen(wPtr, 'Flip');                pause(1.5);        Screen('TextFont',wPtr,'Arial');        Screen('TextSize',wPtr,19);        Screen('DrawText',wPtr,'Appuyez sur un bouton',(a1+35),b1,255);        vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));        end            else                % Train & test screen and procedure        Screen('FillRect',wPtr,gray);        vbl=Screen(wPtr, 'Flip');        if eyetracker ==2            Eyelink('Message',sprintf('TRIALSYNCTIME #%d %s',b, datestr(now,'HH:MM:SS')));        end                        Screen('TextFont',wPtr,'Arial');        Screen('TextSize',wPtr,19);        Screen('DrawText',wPtr,['Trial suivant ',num2str(b)],(a1),b1,255);        vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));                WaitSecs(2.5);        % remove the "press a button" screen to start each trial??        Screen('TextFont',wPtr,'Arial');        Screen('TextSize',wPtr,19);        Screen('DrawText',wPtr,'Appuyez sur un bouton',(a1),b1,255);        vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));            end            tic;        FlushEvents;    resp_num=CharAvail;        while resp_num~='cvbnq'   % response keys cvbn and q to quit        resp_num=GetChar;    end    centre_time(b)=toc;            if resp_num=='q'        break;    elseif session==2 && b>3        break;    else    end            Screen('FillRect',wPtr,[255 255 255], [a1 b1 (a1+tailleCible) (b1+tailleCible)]); % target 1    Screen('FillRect',wPtr,[255 255 255], [a2 b2 (a2+tailleCible) (b2+tailleCible)]); % target 2    Screen('FillRect',wPtr,[255 255 255], [a3 b3 (a3+tailleCible) (b3+tailleCible)]); % target 3    Screen('FillRect',wPtr,[255 255 255], [a4 b4 (a4+tailleCible) (b4+tailleCible)]); % target 4        Screen('FillRect',wPtr,[0 0 0], [a1+2 b1+2 (a1+(tailleCible-2)) (b1+(tailleCible-2))]); % target 1    Screen('FillRect',wPtr,[0 0 0], [a2+2 b2+2 (a2+(tailleCible-2)) (b2+(tailleCible-2))]); % target 2    Screen('FillRect',wPtr,[0 0 0], [a3+2 b3+2 (a3+(tailleCible-2)) (b3+(tailleCible-2))]); % target 3    Screen('FillRect',wPtr,[0 0 0], [a4+2 b4+2 (a4+(tailleCible-2)) (b4+(tailleCible-2))]); % target 4        vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));        % Delay: Variable foreperiod    k=Rd(b);    if session==2        WaitSecs(0);    else        WaitSecs(k);    end        start=GetSecs;        for n=1:12                HideCursor;                %creates the box(es)        Screen('FillRect',wPtr,[255 255 255], [a1 b1 (a1+tailleCible) (b1+tailleCible)]); % target 1        Screen('FillRect',wPtr,[255 255 255], [a2 b2 (a2+tailleCible) (b2+tailleCible)]); % target 2        Screen('FillRect',wPtr,[255 255 255], [a3 b3 (a3+tailleCible) (b3+tailleCible)]); % target 3        Screen('FillRect',wPtr,[255 255 255], [a4 b4 (a4+tailleCible) (b4+tailleCible)]); % target 4                Screen('FillRect',wPtr,[0 0 0], [a1+2 b1+2 (a1+(tailleCible-2)) (b1+(tailleCible-2))]); % target 1        Screen('FillRect',wPtr,[0 0 0], [a2+2 b2+2 (a2+(tailleCible-2)) (b2+(tailleCible-2))]); % target 2        Screen('FillRect',wPtr,[0 0 0], [a3+2 b3+2 (a3+(tailleCible-2)) (b3+(tailleCible-2))]); % target 3        Screen('FillRect',wPtr,[0 0 0], [a4+2 b4+2 (a4+(tailleCible-2)) (b4+(tailleCible-2))]); % target 4                SRep=Seq_repeated(n);                if session==2                        if (SRep==1) % target 1                                vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));                                % Target hitted or not                tic;                FlushEvents;                resp_num=CharAvail;                                while resp_num~='cvbn'    % correct response : c                    resp_num=GetChar;                end                Target_time(n)=toc;                                if resp_num=='c'                    FB(n)=1; % correct response                else                    FB(n)=0; % uncorrect response                end                            elseif (SRep==2) % target 2                                vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));                                % Target hitted or not                tic;                FlushEvents;                resp_num=CharAvail;                                while resp_num~='cvbn'    % correct response : v                    resp_num=GetChar;                end                Target_time(n)=toc;                                if resp_num=='v'                    FB(n)=1;                else                    FB(n)=0;                end                            elseif (SRep==3) % target 3                                vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));                                % Target hitted or not                tic;                FlushEvents;                resp_num=CharAvail;                                while resp_num~='cvbn'    % correct response : b                    resp_num=GetChar;                end                Target_time(n)=toc;                                if resp_num=='b'                    FB(n)=1;                else                    FB(n)=0;                end                            elseif (SRep==4) % target 4                                vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));                                % Target hitted or not                tic;                FlushEvents;                resp_num=CharAvail;                                while resp_num~='cvbn'    % correct response : n                    resp_num=GetChar;                end                Target_time(n)=toc;                                if resp_num=='n'                    FB(n)=1;                else                    FB(n)=0;                end                            else                Screen('TextFont',wPtr,'Arial');                Screen('TextSize',wPtr,20);                Screen('DrawText',wPtr,'Problem! Matlab closing...',(a1+70),b1,255);                vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));                pause(4);                quit;            end                    else                        if (SRep==1)                Screen('FillRect',wPtr, color, [a1+2 b1+2 (a1+(tailleCible-2)) (b1+(tailleCible-2))]);                vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));                                if eyetracker == 2                    Eyelink('Message', 'USEREVENT "SEQSTEP%d TRIAL%d"', n, b);                end                                % Target hitted or not                tic;                FlushEvents;                resp_num=CharAvail;                                while resp_num~='cvbn'    % correct response : c                    resp_num=GetChar;                end                Target_time(n)=toc;                                if resp_num=='c'                    FB(n)=1;                else                    FB(n)=0;                end                            elseif (SRep==2) % target 2                Screen('FillRect',wPtr, color, [a2+2 b2+2 (a2+(tailleCible-2)) (b2+(tailleCible-2))]);                vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));                                if eyetracker == 2                    Eyelink('Message', 'USEREVENT "SEQSTEP%d TRIAL%d"', n, b);                end                                % Target hitted or not                tic;                FlushEvents;                resp_num=CharAvail;                                while resp_num~='cvbn'    % correct response : v                    resp_num=GetChar;                end                Target_time(n)=toc;                                if resp_num=='v'                    FB(n)=1;                else                    FB(n)=0;                end                            elseif (SRep==3) % target 3                Screen('FillRect',wPtr, color, [a3+2 b3+2 (a3+(tailleCible-2)) (b3+(tailleCible-2))]);                vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));                                if eyetracker == 2                    Eyelink('Message', 'USEREVENT "SEQSTEP%d TRIAL%d"', n, b);                end                                % Target hitted or not                tic;                FlushEvents;                resp_num=CharAvail;                                while resp_num~='cvbn'    % correct response : b                    resp_num=GetChar;                end                Target_time(n)=toc;                                if resp_num=='b'                    FB(n)=1;                else                    FB(n)=0;                end                            elseif (SRep==4) % target 4                Screen('FillRect',wPtr, color, [a4+2 b4+2 (a4+(tailleCible-2)) (b4+(tailleCible-2))]);                vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));                                if eyetracker == 2                    Eyelink('Message', 'USEREVENT "SEQSTEP%d TRIAL%d"', n, b);                end                                % Target hitted or not                tic;                FlushEvents;                resp_num=CharAvail;                                while resp_num~='cvbn'    % correct response : n                    resp_num=GetChar;                end                Target_time(n)=toc;                                if resp_num=='n'                    FB(n)=1;                else                    FB(n)=0;                end                            else                Screen('TextFont',wPtr,'Arial');                Screen('TextSize',wPtr,20);                Screen('DrawText',wPtr,'Problem! Matlab closing...',(a1+80),b1,255);                vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));                pause(4);                quit;            end        end    end    % eyetracker message at end of each trial loop    if eyetracker ==2    Eyelink('Message',sprintf('STOPTTRIAL #%d:  %s', b, datestr(now,'yyyy-mm-dd HH:MM:SS')));    end           RT=Target_time;    Feedback=FB;        %     black=BlackIndex(wPtr);    Screen('FillRect',wPtr,gray);    vbl=Screen(wPtr, 'Flip');        save2hdd([path '/Groupe',num2str(groupe),'Session',num2str(session),'_Sujet',num2str(sujet),'_B',num2str(b),'_RT.txt'], [RT]);    save2hdd([path '/Groupe',num2str(groupe),'Session',num2str(session),'_Sujet',num2str(sujet),'_B',num2str(b),'_FB.txt'], [Feedback]);        %% Feedback  after each block    %question at end of trial    if session==1 && groupe==2                Screen('TextFont',wPtr,'Arial');        Screen('TextSize',wPtr,19);        Screen('DrawText',wPtr,'Fluidite maximale sur la tache?',(a1-50),b1-50,255);        Screen('DrawText',wPtr,'Repondez oui(1) ou non(2)',(a1-50),b1,255);        vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));        if eyetracker ==2            Eyelink('Message', 'USEREVENT "start-EVALUATIONSCREEN_TRIAL%d"', b);        end                % Response yes/no        FlushEvents;        resp_key=CharAvail;        while resp_key~='&??'   % response keys 12            resp_key=GetChar;        end        if eyetracker ==2            Eyelink('Message', 'USEREVENT "end-EVALUATIONSCREEN_TRIAL%d"', b);        end        %save response file, changing for french keyboard........        if resp_key == '&'            resp_key = '1'; % yes        else            resp_key = '2'; % no        end        pressed_response(b)= resp_key;        LS=pressed_response(b);        save2hdd([path '/Groupe',num2str(groupe),'_Sujet',num2str(sujet),'_B',num2str(b),'_LS.txt'], [LS]);    endendScreen('FillRect',wPtr,gray);vbl=Screen(wPtr, 'Flip');pause(2.5);if  session==2 && b==3 % introduction Questionnaire (paper) => after the Completion test %%%%%%%%%%% START QUESTIONNAIRE LOOP        Screen('FillRect',wPtr,gray);    vbl=Screen(wPtr, 'Flip');        Screen('TextFont',wPtr,'Arial');    Screen('TextSize',wPtr,19);    Screen('DrawText',wPtr,['Test: Ecrivez la sequence sur papier'],(a1-20),b1,255);    Screen('DrawText',wPtr,'(Appuyez barre espace quand termine)',(a1-15),b1+35,255);    vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));            kc_space2 = KbName('Space');    startTime = GetSecs();    while 1        [keyIsDown secs keycodes] = KbCheck();                if keycodes(kc_space2)            break        end    end        Screen('FillRect',wPtr,gray);    vbl=Screen(wPtr, 'Flip');    pause(2);    elseend %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% END QUESTIONNAIRE LOOP%% finalise eye trackerif eyetracker == 2    % eyetracker message at end of experiment    Eyelink('Message', 'USEREVENT "ENDOFEXPERIMENT"');     Eyelink('StopRecording');    finishEyelink(path,['eyeData_' dnow,'Groupe',num2str(groupe),'Sujet',num2str(sujet) '.edf']);end%% End of the programScreen('FillRect',wPtr,gray);vbl=Screen(wPtr, 'Flip');Screen('TextFont',wPtr,'Arial');Screen('TextSize',wPtr,19);Screen('DrawText',wPtr,['Session ',num2str(session),' Termine!'],(a1-10),b1,255);vbl=Screen('Flip',wPtr, vbl+(flipSpd*monitorFlipInterval));pause(8);Screen('Close', wPtr);Screen('CloseAll'); % quit